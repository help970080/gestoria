// ============================================
// GOOGLE APPS SCRIPT - LGX COBRANZA
// Versión 2.1 - LISTO PARA USAR
// ============================================

// ID de tu hoja de cálculo
const SPREADSHEET_ID = '19Zmr5iti-cUH6FQO951_P8TxJv-1DpgqE6OMNNt9sfc';

// Nombres de las hojas
const SHEETS = {
  CLIENTES: 'Clientes',
  PAGOS: 'Pagos',
  CONVENIOS: 'Convenios',
  CONFIG: 'Config'
};

// ============================================
// FUNCIONES PRINCIPALES HTTP
// ============================================

function doGet(e) {
  return handleRequest(e, 'GET');
}

function doPost(e) {
  return handleRequest(e, 'POST');
}

function handleRequest(e, method) {
  try {
    const action = e.parameter.action || 'ping';
    let data = null;
    
    // Obtener datos del POST
    if (method === 'POST' && e.postData) {
      try {
        data = JSON.parse(e.postData.contents);
      } catch (err) {
        if (e.parameter.data) {
          data = JSON.parse(e.parameter.data);
        }
      }
    } else if (e.parameter.data) {
      data = JSON.parse(e.parameter.data);
    }
    
    let result;
    
    switch(action) {
      case 'ping':
        result = { success: true, message: 'API funcionando', timestamp: new Date().toISOString() };
        break;
        
      case 'fullSync':
        result = getFullData();
        break;
        
      case 'getClientes':
        result = getClientes();
        break;
        
      case 'getPagos':
        result = getPagos();
        break;
        
      case 'getConvenios':
        result = getConvenios();
        break;
        
      case 'addPago':
        result = addPago(data);
        break;
        
      case 'addConvenio':
        result = addConvenio(data);
        break;
        
      case 'updateConvenio':
        result = updateConvenio(data);
        break;
        
      case 'importClientes':
      case 'bulkUpload':
        result = importClientes(data);
        break;
        
      case 'updateCliente':
        result = updateCliente(data);
        break;
        
      default:
        result = { success: false, error: 'Acción no reconocida: ' + action };
    }
    
    return createResponse(result);
    
  } catch (error) {
    return createResponse({ 
      success: false, 
      error: error.toString(),
      stack: error.stack 
    });
  }
}

// ============================================
// RESPUESTA JSON
// ============================================

function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// ============================================
// FUNCIONES DE DATOS
// ============================================

function getSpreadsheet() {
  return SpreadsheetApp.openById(SPREADSHEET_ID);
}

function getOrCreateSheet(name) {
  const ss = getSpreadsheet();
  let sheet = ss.getSheetByName(name);
  
  if (!sheet) {
    sheet = ss.insertSheet(name);
    
    // Crear encabezados según el tipo de hoja
    if (name === SHEETS.CLIENTES) {
      sheet.getRange(1, 1, 1, 15).setValues([[
        'Teléfono', 'Nombre', 'Dirección', 'Equipo', 'Precio',
        'Enganche', 'Saldo', 'SaldoOriginal', 'Tarifa', 'Días Atraso',
        'Riesgo', 'Promotor', 'Última Trans.', 'Agencia', 'FechaCreado'
      ]]);
    } else if (name === SHEETS.PAGOS) {
      sheet.getRange(1, 1, 1, 12).setValues([[
        'id', 'Teléfono', 'amount', 'date', 'capturista',
        'note', 'folio', 'saldoAntes', 'saldoDespues', 'timestamp',
        'tipo', 'semana'
      ]]);
    } else if (name === SHEETS.CONVENIOS) {
      sheet.getRange(1, 1, 1, 12).setValues([[
        'id', 'Teléfono', 'saldoInicial', 'montoSemanal', 'semanasTotales',
        'semanasRestantes', 'fechaInicio', 'estado', 'historial', 'notas',
        'ultimoPago', 'created'
      ]]);
    }
  }
  
  return sheet;
}

// ============================================
// OBTENER DATOS
// ============================================

function getFullData() {
  return {
    success: true,
    data: {
      clientes: getClientes().data || [],
      pagos: getPagos().data || [],
      convenios: getConvenios().data || []
    },
    timestamp: new Date().toISOString()
  };
}

function getClientes() {
  try {
    const sheet = getOrCreateSheet(SHEETS.CLIENTES);
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return { success: true, data: [] };
    }
    
    const headers = data[0];
    const clientes = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0]) {
        const cliente = {};
        headers.forEach((header, index) => {
          cliente[header] = row[index];
        });
        clientes.push(cliente);
      }
    }
    
    return { success: true, data: clientes };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function getPagos() {
  try {
    const sheet = getOrCreateSheet(SHEETS.PAGOS);
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return { success: true, data: [] };
    }
    
    const headers = data[0];
    const pagos = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0]) {
        const pago = {};
        headers.forEach((header, index) => {
          pago[header] = row[index];
        });
        pagos.push(pago);
      }
    }
    
    return { success: true, data: pagos };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function getConvenios() {
  try {
    const sheet = getOrCreateSheet(SHEETS.CONVENIOS);
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return { success: true, data: [] };
    }
    
    const headers = data[0];
    const convenios = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0]) {
        const convenio = {};
        headers.forEach((header, index) => {
          if (header === 'historial' && typeof row[index] === 'string') {
            try {
              convenio[header] = JSON.parse(row[index]);
            } catch (e) {
              convenio[header] = [];
            }
          } else {
            convenio[header] = row[index];
          }
        });
        convenios.push(convenio);
      }
    }
    
    return { success: true, data: convenios };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

// ============================================
// AGREGAR DATOS
// ============================================

function addPago(pago) {
  try {
    const sheet = getOrCreateSheet(SHEETS.PAGOS);
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    const row = headers.map(header => pago[header] || '');
    sheet.appendRow(row);
    
    return { success: true, message: 'Pago agregado', id: pago.id };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function addConvenio(convenio) {
  try {
    const sheet = getOrCreateSheet(SHEETS.CONVENIOS);
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    const row = headers.map(header => {
      if (header === 'historial' && Array.isArray(convenio[header])) {
        return JSON.stringify(convenio[header]);
      }
      return convenio[header] || '';
    });
    
    sheet.appendRow(row);
    
    return { success: true, message: 'Convenio agregado', id: convenio.id };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function updateConvenio(data) {
  try {
    const sheet = getOrCreateSheet(SHEETS.CONVENIOS);
    const allData = sheet.getDataRange().getValues();
    const headers = allData[0];
    const idIndex = headers.indexOf('id');
    
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][idIndex] === data.id) {
        headers.forEach((header, colIndex) => {
          if (data[header] !== undefined) {
            let value = data[header];
            if (header === 'historial' && Array.isArray(value)) {
              value = JSON.stringify(value);
            }
            sheet.getRange(i + 1, colIndex + 1).setValue(value);
          }
        });
        return { success: true, message: 'Convenio actualizado' };
      }
    }
    
    return { success: false, error: 'Convenio no encontrado' };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

function updateCliente(data) {
  try {
    const sheet = getOrCreateSheet(SHEETS.CLIENTES);
    const allData = sheet.getDataRange().getValues();
    const headers = allData[0];
    const idIndex = headers.indexOf('Teléfono');
    
    for (let i = 1; i < allData.length; i++) {
      if (allData[i][idIndex] === data.Teléfono) {
        headers.forEach((header, colIndex) => {
          if (data[header] !== undefined) {
            sheet.getRange(i + 1, colIndex + 1).setValue(data[header]);
          }
        });
        return { success: true, message: 'Cliente actualizado' };
      }
    }
    
    return { success: false, error: 'Cliente no encontrado' };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

// ============================================
// IMPORTAR CLIENTES
// ============================================

function importClientes(data) {
  try {
    const sheet = getOrCreateSheet(SHEETS.CLIENTES);
    const clientes = data.data || data.clientes || data;
    
    if (!Array.isArray(clientes) || clientes.length === 0) {
      return { success: false, error: 'No hay clientes para importar' };
    }
    
    // Obtener headers actuales o usar los del primer cliente
    let headers;
    const existingData = sheet.getDataRange().getValues();
    
    if (existingData.length > 0 && existingData[0].length > 1) {
      headers = existingData[0];
    } else {
      // Crear headers basados en el primer cliente
      headers = Object.keys(clientes[0]);
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    }
    
    // Crear mapa de clientes existentes por teléfono
    const telefonoIndex = headers.indexOf('Teléfono');
    const existingMap = {};
    
    for (let i = 1; i < existingData.length; i++) {
      if (existingData[i][telefonoIndex]) {
        existingMap[existingData[i][telefonoIndex]] = i + 1;
      }
    }
    
    let added = 0;
    let updated = 0;
    
    // Procesar en lotes para evitar timeout
    clientes.forEach(cliente => {
      const tel = cliente.Teléfono || cliente.telefono;
      const row = headers.map(header => {
        const value = cliente[header];
        return value !== undefined ? value : '';
      });
      
      if (existingMap[tel]) {
        sheet.getRange(existingMap[tel], 1, 1, headers.length).setValues([row]);
        updated++;
      } else {
        sheet.appendRow(row);
        existingMap[tel] = sheet.getLastRow();
        added++;
      }
    });
    
    return { 
      success: true, 
      message: 'Importación completada',
      added: added,
      updated: updated,
      total: clientes.length
    };
  } catch (error) {
    return { success: false, error: error.toString() };
  }
}

// ============================================
// FUNCIÓN DE PRUEBA
// ============================================

function testAPI() {
  const result = getFullData();
  console.log(JSON.stringify(result, null, 2));
}
